---
title: "02_kidney_data_GSE129798"
author: "YinCY"
date: "2023-03-01"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# prepare dev cell data
data from GSE129798
```{r}
library(DropletUtils)
library(scran)
library(scuttle)
library(scater)
library(magrittr)

dev_cell_sce <- read10xCounts(samples = "../data/kidney/kidney-map/GSE129798/Mouse_Adult_DGE/", 
                              type = "sparse", 
                              col.names = TRUE)
dev_cell_sce %>% colData()
dev_cell_sce %>% rowData() %>% .$ID %>% duplicated() %>% table

# use the newest annotation data
library(AnnotationHub)
ah <- AnnotationHub()
query(ah, c("EnsDb", "Mus Musculus"))
ens107 <- ah[["AH104895"]]
ens107 %>% columns

rowData(dev_cell_sce)$ensembl <- mapIds(ens107, 
                                        keys = rowData(dev_cell_sce)$ID, 
                                        keytype = "SYMBOL", 
                                        column = "GENEID")

rowData(dev_cell_sce)$ensembl %>% is.na() %>% table()
dev_cell_sce <- dev_cell_sce[!is.na(rowData(dev_cell_sce)$ensembl), ]
rownames(dev_cell_sce) <- rowData(dev_cell_sce)$ensembl
rowData(dev_cell_sce)

colData(dev_cell_sce)$region <- substr(colData(dev_cell_sce)$Barcode, 1, 2)
colData(dev_cell_sce)$batch <- substr(colData(dev_cell_sce)$Barcode, 1, 4)
colData(dev_cell_sce)$gender <- substr(colData(dev_cell_sce)$Barcode, 4, 4)
colData(dev_cell_sce)

# retain only the male data
dev_cell_sce <- dev_cell_sce[, dev_cell_sce$gender == "M"]

table(colData(dev_cell_sce)$gender);table(colData(dev_cell_sce)$batch);table(colData(dev_cell_sce)$region)
```

```{r}
# quality control
is_mito <- grepl("^mt-", rowData(dev_cell_sce)$ID, ignore.case = F)
is_mito %>% table
rowData(dev_cell_sce)$ID[is_mito] %>% sort
colData(dev_cell_sce)$mito_percent <- round((colSums2(assay(dev_cell_sce[is_mito, ])) / colSums2(assay(dev_cell_sce))) * 100, 4)

qclusters <- quickCluster(dev_cell_sce, 
                         min.size = 1000, 
                         method = "igraph", 
                         use.ranks = T, 
                         d = 50)
qclusters %>% table
colData(dev_cell_sce)$quick_cluster <- qclusters

library(tibble)
library(patchwork)
colData(dev_cell_sce) %>% 
    as_tibble() %>% 
    ggplot(aes(region, quick_cluster)) +
    geom_jitter(size = 0.1) +

colData(dev_cell_sce) %>% 
    as_tibble() %>% 
    ggplot(aes(region, mito_percent)) +
    geom_jitter(size = 0.1)

stats <- perCellQCMetrics(dev_cell_sce, subsets = list(mito = is_mito))
qc <- perCellQCFilters(stats, sub.fields = "subsets_mito_percent")
qc %>% as.matrix() %>% colSums()

# filter based on number of features
dev_cell_sce <- dev_cell_sce[, !qc$low_n_features]
```

```{r}
# normalization
dec_sf_dev_cell <- pooledSizeFactors(dev_cell_sce, clusters = colData(dev_cell_sce)$quick_cluster)
sizeFactors(dev_cell_sce) <- dec_sf_dev_cell
colData(dev_cell_sce)

dev_cell_sce <- logNormCounts(dev_cell_sce)
dev_cell_sce
```


```{r}
# feature selection
library(magrittr)
library(stringr)
library(scuttle)
library(scran)
library(scater)
library(BiocParallel)

dec_dev_cell <- modelGeneVar(dev_cell_sce, block = colData(dev_cell_sce)$batch)
dec_dev_cell[order(dec_dev_cell$bio, decreasing = T), ]
```

```{r}
par(mfrow = c(1, 3))
for(i in 1:ncol(dec_dev_cell$per.block)){
    plot(metadata(dec_dev_cell$per.block[[i]])$mean, 
         metadata(dec_dev_cell$per.block[[i]])$var, 
         pch = 19, cex = 0.5, 
         main = paste0("model_", names(dec_dev_cell$per.block)[[i]]))
    curve(metadata(dec_dev_cell$per.block[[i]])$trend(x), col = "red", lwd = 2, add = TRUE)
}
```



```{r}
dev_cell_hvgs <- getTopHVGs(stats = dec_dev_cell, 
                            var.field = "bio",
                            var.threshold = 0, 
                            fdr.threshold = 0.01)
dev_cell_hvgs %>% str

# choosing the number of PCs
npcs <- calculatePCA(dev_cell_sce, subset_row = dev_cell_hvgs, ncomponents = 50)
percentvar <- attr(npcs, which = "percentVar")

library(PCAtools)
elbow <- findElbowPoint(percentvar)

df <- data.frame(PCs = 1:dim(npcs)[2], 
                 percentvar = percentvar)

df %>% 
    ggplot(aes(PCs, percentvar)) + 
    geom_line() + 
    geom_point() +
    geom_vline(xintercept = elbow) +
    scale_y_continuous(trans = "log2")

reducedDim(dev_cell_sce, "PCA") <- npcs[, 1:9]

set.seed(110)
dev_cell_sce <- runTSNE(x = dev_cell_sce, 
                        dimred = "PCA", 
                        perplexity = 10, 
                        BPPARAM = MulticoreParam(workers = 12))

plotTSNE(dev_cell_sce, 
         colour_by = "quick_cluster", 
         point_size = 0.5, 
         text_by = "quick_cluster")
```


```{r}
# dev_cell_sce <- readRDS("../data/kidney/kidney-map/dev-cell/dev_cell_sce.rds")
# graph based clustering
library(scran)
library(igraph)
library(scater)
library(BiocParallel)
library(bluster)

grep("^cluster_", ls("package:igraph"), value = T)

clusters <- clusterRows(reducedDim(dev_cell_sce, "PCA"), 
                        BLUSPARAM = SNNGraphParam(k = 10, 
                                                  cluster.fun = "louvain"))
clusters %>% table



colData(dev_cell_sce)$clusters <- factor(clusters)
colData(dev_cell_sce)

plotTSNE(dev_cell_sce, 
         colour_by = "clusters", 
         point_size = 0.5, 
         text_by = "clusters")
```

```{r}
# highlight each cluster and sub-cluster
for( n in levels(colData(dev_cell_sce)$clusters)){
    my_color <- rep("grey", length(colData(dev_cell_sce)$clusters))
    names(my_color) <- as.character(colData(dev_cell_sce)$clusters)
    my_color[colData(dev_cell_sce)$clusters == n] <- "red"
    
    plotReducedDim(object = dev_cell_sce, 
                   dimred = "TSNE", 
                   colour_by = "clusters", 
                   text_by = "clusters", 
                   point_size = 0.2) +
        scale_color_manual(values = my_color) +
        guides(colour = guide_legend(override.aes = list(size = 2)))
    
    ggsave(paste0("dev_image/the-", n, "th-cluster.pdf"))
}
```


```{r}
# doublet detection
library(scDblFinder)
dbs <- findDoubletClusters(dev_cell_sce, clusters = colData(dev_cell_sce)$clusters)
dbs %>% as.data.frame()
outs <- rownames(dbs)[isOutlier(dbs$median.de, type = "lower", log = TRUE)]

# cluster 2 and 15 are doublets
# remove cluster 2 and 15
dev_cell_sce <- dev_cell_sce[, !(colData(dev_cell_sce)$clusters %in% c(2, 15))]
colLabels(dev_cell_sce) <- factor(colData(dev_cell_sce)$clusters, levels = setdiff(1:20, c(2, 15)))
dev_cell_sce %>% colData()
```


```{r}
# marker gene detection
markers <- scoreMarkers(x = dev_cell_sce, 
                        groups = colLabels(dev_cell_sce))

source("R/idconv.R")
markers[["1"]][order(markers[["1"]]$min.AUC, decreasing = T), ] %>% 
    head(50) %>% 
    as.data.frame() %>% 
    rownames() %>% 
    idconv(from_type = "GENEID", to_type = "SYMBOL")

fmarkers <- findMarkers(dev_cell_sce, 
                        groups = colLabels(dev_cell_sce), 
                        test.type = "wilcox", 
                        pval.type = "all", 
                        direction = "up", 
                        min.prop = 0.25)
fmarkers[["5"]] %>% 
    as.data.frame() %>% 
    dplyr::arrange(FDR) %>% 
    head(50) %>% 
    rownames() %>% 
    idconv(from_type = "GENEID", to_type = "SYMBOL")

plotReducedDim(dev_cell_sce, 
               colour_by = idconv("Csf1r"),
               # colour_by = "mito_percent",
               text_by = "label", 
               dimred = "TSNE", 
               point_size = 0.5)

idconv("Mcam")
ggcells(dev_cell_sce, 
        aes(colLabels(dev_cell_sce), ENSMUSG00000029231)) +
    geom_violin() +
    geom_jitter(size = 0.1)
saveRDS(dev_cell_sce, "../data/kidney/kidney-map/dev-cell/dev_cell_sce.rds")
```

# sub-clusters
```{r}
# 5
c5 <- dev_cell_sce[, colLabels(dev_cell_sce) == 5]
hvgs <- c("H2-Ab1" = "ENSMUSG00000073421",  "H2-Eb1" = "ENSMUSG00000060586", "Csf1r" = "ENSMUSG00000024621", 
          "Fcgr2b" = "ENSMUSG00000026656", "Fcgr3" = "ENSMUSG00000059498", "Cx3cr1" = "ENSMUSG00000052336")
c5 <- runPCA(c5, exprs_values = "logcounts", 
             ncomponents = 2, 
             subset_row = hvgs)
c5 <- runTSNE(c5, perplexity = 30, dimred = "PCA")

g_c5 <- buildSNNGraph(c5, k = 100, use.dimred = "TSNE")
clusters_c5 <- cluster_louvain(g_c5)$membership
clusters_c5 %>% table
colLabels(c5) <- ifelse(clusters_c5 == 3, 2, clusters_c5)
colLabels(c5) <- paste("5.", colLabels(c5), sep = "")
labels <- as.character(colLabels(dev_cell_sce))
labels[labels == "5"] <- colLabels(c5)
colLabels(dev_cell_sce) <- labels
plotReducedDim(c5, dimred = "TSNE", colour_by = idconv("H2-Ab1"), text_by = "label")


# 16
hvgs <- c("Cspg4" = "ENSMUSG00000032911", 
          "Cnn1" = "ENSMUSG00000001349", 
          "Pdgfrb" = "ENSMUSG00000024620", 
          "Des" = "ENSMUSG00000026208", 
          "Mcam" = "ENSMUSG00000032135")
c16 <- dev_cell_sce[, colLabels(dev_cell_sce) == 16]
c16 <- runPCA(c16, subset_row = hvgs, ncomponents = 2, exprs_values = "logcounts")
c16 <- runTSNE(c16, perplexity = 30, use.dimred = "PCA")
g_c16 <- buildSNNGraph(c16, k = 100, use.dimred = "TSNE")
clusters_c16 <- cluster_louvain(g_c16)$membership
clusters_c16 %>% table
colLabels(c16) <- clusters_c16
plotReducedDim(c16, colour_by = idconv("Cnn1"), text_by = "label", dimred = "TSNE")

labels <- colLabels(dev_cell_sce)
labels[labels == 16] <- paste("16.", clusters_c16, sep = "")
labels %>% table
colLabels(dev_cell_sce) <- factor(labels, levels = c(1, 3, 4, 5.1, 5.2, 6:15, 16.1, 16.2, 17:19))
colLabels(dev_cell_sce)
saveRDS(dev_cell_sce, "../data/kidney/kidney-map/dev-cell/dev_cell_sce.rds")
```



```{r}
# cell type annotation base on marker genes
markers <- list(
    endothelia = c("Cdh5", "Pecam1", "Kdr", "Nrp1"), 
    macrophage = c("C1qa", "C1qb", "C1qc", "Cx3cr1", "Lyz2"), 
    T_cell = c("Thy1", "Cd3g", "Cd3d"), 
    B_cell = c("Cd79a", "Cd79b"),
    NK = c("Tyrobp"), 
    DC = c("H2-Eb1", "H2-Ab1"),
    Monocytes = c("Csf1r"),
    VSMC = c("Cnn1"), 
    pericyte = c("Cspg4"), 
    Fibroblast = c("Dcn"), 
    PTS1 = c("Slc5a2", "Slc5a12", "Slc7a7", "Spp2", "Slc6a19", "Slc22a29"),
    PTS2 = c("Fxyd2", "Hrsp12"), 
    PTS3 = c("Atp11a", "Slc13a3", "Slc27a2"),
    CD_IC = c("Atp6v1g3", "Slc4a1", "Aqp6", "Slc26a4", "Hmx2"),
    CD_PC = c("Hsd11b2", "Aqp4", "Aqp2"),
    DCT = c("Pvalb", "Slc12a3"),
    LOH = c("Clcnka", "Slc12a1", "Umod", "Sptssb")
)

cell_annotation <- c(
    "1" = "Endothelial",
    "3" = "PTS1",
    "4" = "CD_IC",
    "5" = "Natural Killer cells",
    "5.1" = "Dendritic cell",
    "5.2" = "Monocyte",
    "6" = "PTS3", 
    "7" = "Macrophages",
    "8" = "DCT",
    "9" = "Endothelial",
    "10" = "PTS2", 
    "11" = "CD_PC", 
    "12" = "LOH", 
    "13" = "Dendritic cells", 
    "14" = "T cells",
    "15" = "Fibroblast", 
    "16.1" = "VSMC",
    "16.2" = "Pericyte",
    "17" = "Endothelial",
    "18" = "",
    "19" = "Endothelial", 
    "20" = ""
)
cell_annotation
colData(dev_cell_sce)$cell_type <- cell_annotation[colLabels(dev_cell_sce)]
dev_cell_sce %>% colData()
saveRDS(dev_cell_sce, "../data/kidney/kidney-map/dev-cell/dev_cell_sce.rds")


library(SingleR)
dev_pre <- readRDS("../data/kidney/kidney-map/GSE129798/dev_cell_sce.rds")
pre_label <- SingleR(test = dev_cell_sce, 
                     ref = dev_pre, 
                     labels = dev_pre$cell_type)


```


## annotate region information
```{r}
library(SingleR)
library(magrittr)

dev_cell_sce <- readRDS("../data/kidney/kidney-map/dev-cell/dev_cell_sce.rds")
ref_mouse_tubule_sce <- readRDS("../data/kidney/kidney-map/mouse-tubule/ref_mouse_tubule_sce.rds")
colData(ref_mouse_tubule_sce)

cell_to_annotate <- c("PTS1", "PTS2", "PTS3", "LOH", "CD_PC", "CD_IC", "DCT")
subs_dev_cell_tubule <- dev_cell_sce[, dev_cell_sce$cell_type %in% cell_to_annotate]

tubule_pred <- SingleR(test = subs_dev_cell_tubule, 
                       ref = ref_mouse_tubule_sce, 
                       labels = ref_mouse_tubule_sce$region, 
                       assay.type.test = "logcounts", 
                       assay.type.ref = "tpm", 
                       de.method = "t", 
                       de.n = 15)

ref_mouse_tubule_sce %>% colData()
tubule_pred$labels %>% table
```

```{r}
# regional information
library(tibble)
tubule_region_info <- tibble(
    short_name = c("ATL", "CCD", "CNT", 
                   "CTAL", "DCT", "DTL1", 
                   "DTL2", "DTL3", "IMCD", 
                   "MTAL", "OMCD", "PTS1", 
                   "PTS2", "PTS3"), 
    long_name = c("thin ascending limb of the loop of Henle", 
                  "cortical collecting duct", 
                  "connecting tubule", 
                  "cortical thick ascending limb of the loop of Henle", 
                  "distal convoluted tubule", 
                  "the short descending limb of the loop of Henle", 
                  "long descending limb of the loop of Henle in the outer medulla", 
                  "long descending limb of the loop of Henle in the inner medulla", 
                  "inner medullary collecting duct", 
                  "medullary thick ascending limb of the loop of Henle", 
                  "outer medullary collecting duct", 
                  "the initial segment of the proximal tubule", 
                  "proximal straight tubule in cortical medullary rays", 
                  "last segment of the proximal straight tubule in the outer stripe of medulla")
)

tubule_region_info
```

```{r}
knitr::include_graphics("../data/kidney/kidney-map/mouse-tubule/tubule_region.png")
```



```{r}
# quality check
tubule_pred$scores %>% 
    pheatmap::pheatmap(angle_col = 315, 
                       cluster_cols = T, 
                       color = viridis::viridis(n = 1000, option = "D"))

plotDeltaDistribution(tubule_pred, 
                      show = "delta.med")

marker_low_assignments <- pruneScores(results = tubule_pred, 
                                      nmads = 3) %>% table
```


```{r}
colData(subs_dev_cell_tubule)$location <- tubule_pred$labels
colData(subs_dev_cell_tubule)$assignment_quality_score <- ifelse(pruneScores(tubule_pred) == FALSE, "high", "low")
colData(subs_dev_cell_tubule)
```

```{r}
# assign the location information back to the dev_cell_sce object
others <- dev_cell_sce[, !colData(dev_cell_sce)$cell_type %in% cell_to_annotate] 
others %>% colData() %>% colnames(); subs_dev_cell_tubule %>% colData %>% colnames()
colData(others)$location <- ""
colData(others)$assignment_quality_score <- ""
dev_cell_sce2 <- cbind(others, subs_dev_cell_tubule)

# remove low assignment score cells
dev_cell_sce2 %>% colData() %>% .$assignment_quality_score %>% table(useNA = "ifany")
dev_cell_sce2 <- dev_cell_sce2[, which(colData(dev_cell_sce2)$assignment_quality_score != "low")]


# assese the assignment quality 
table(colData(subs_dev_cell_tubule[, subs_dev_cell_tubule$assignment_quality_score == "high"])$region, 
      colData(subs_dev_cell_tubule[, subs_dev_cell_tubule$assignment_quality_score == "high"])$location) %>% 
    prop.table(margin = 2) %>% round(digits = 3)

# annotate cells with location
colData(dev_cell_sce2)$location_cell <- ifelse(nchar(colData(dev_cell_sce2)$location) == 0, 
                                               colData(dev_cell_sce2)$cell_type, 
                                               paste(colData(dev_cell_sce2)$location, colData(dev_cell_sce2)$cell_type, sep = "_"))
dev_cell_sce2 %>% colData() 

library(scater)
plotReducedDim(dev_cell_sce2, 
               dimred = "TSNE", 
               colour_by = "region", 
               text_by = "location_cell", 
               text_size = 2, 
               point_size = 0.5)

saveRDS(dev_cell_sce2, "../data/kidney/kidney-map/dev-cell/dev_cell_sce.rds")
```























