---
title: "mouse kidney"
author: "YinCY"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# data
1. GSE107585: whole mice kidney single cell sequencing data, 2018 science  
2. GSE129798: whole mice kidney single cell sequencing data, with regional information, 2019 development cell  
3. GSE160048: mice and human glomerular sequencing data  
4. GSE175421: mice sympathetic and sensory nerve sequencing data  
5. PRJCA003940: embryonic and monocytes derived macrophage bulk sequencing data, for reference  
6. GSE150338: microdissected mouse tubules sequencing data, for reference  

remove some very few cells from each dataset.

# annotation cells
## prepare macrophage reference data
```{r}
library(SingleCellExperiment)
library(readxl)
library(org.Mm.eg.db)
?SingleCellExperiment

macrophages <- read_xlsx("../data/kidney/kidney-map/PRJCA003940.xlsx", 
                         sheet = 1)
macrophages <- macrophages[, 1:7]
ref_macrophage_sce <- SingleCellExperiment(
    assays = list(count = macrophages[, 2:7]), 
    rowData = data.frame(Symbol = macrophages[, 1, drop = T]), 
    colData = data.frame(group = rep(c("monocyte derived", "embryonic derived"), each = 3))
)

columns(org.Mm.eg.db)
rowData(ref_macrophage_sce)$ensembl <- mapIds(org.Mm.eg.db, keys = rowData(ref_macrophage_sce)$Symbol, keytype = "SYMBOL", column = "ENSEMBL")
rowData(ref_macrophage_sce)$entrez <- mapIds(org.Mm.eg.db, keys = rowData(ref_macrophage_sce)$Symbol, keytype = "SYMBOL", column = "ENTREZID")
rowData(ref_macrophage_sce)

colData(ref_macrophage_sce)$cell_type <- rep(c("monocytes macrophage", "embryonic macrophage"), each  =3)
colData(ref_macrophage_sce)

saveRDS(ref_macrophage_sce, "../data/kidney/kidney-map/macrophage/ref_macrophage_sce.rds")
```


## prepare mouse tubula sequencing data

```
PTS1, initial segment of the proximal convoluted tubule  
PTS2, proximal straight tubule in cortical medullary rays  
PTS3, last segment of the proximal straight tubule in outer stripe of outer medulla  
DTL1, short descending limb of the loop of Henle  
DTL2, long descending limb of the loop of Henle in the outer medulla  
DTL3, long descending limb of the loop of Henle in the inner medulla  
ATL, thin ascending limb of the loop of Henle  
MTAL, medullary thick ascending limb of the loop of Henle  
CTAL, cortical thick ascending limb of the loop of Henle  
DCT, distal convoluted tubule  
CNT, connecting tubule  
CCD, cortical collecting duct  
OMCD, outer medullary collecting duct  
IMCD, inner medullary collecting duct  
```


```{r}
library(dplyr)
library(stringr)

mouse_tubule <- read.table("../../git/data/kidney/kidney-map/mouse-tubule/GSE150338_Mouse_TPM_Replicates.txt", 
                           header = T, 
                           sep = "\t", 
                           na.strings = "#N/A", 
                           comment.char = "")
mouse_tubule %>% dim
mouse_tubule %>% tail
mouse_tubule %>% head
mouse_tubule %>% colnames()
mouse_tubule$X %>% table(useNA = "ifany")
# discate glomerila 
mouse_tubule <- mouse_tubule %>% select(!matches("_GL_|X"))
rowdata <- mouse_tubule[, 1:3]
coldata <- data.frame(sample = colnames(mouse_tubule[, -c(1:3)]), 
                      region = gsub("m[0-9]{0,}_|_[a-z]{0,}", replacement = "", colnames(mouse_tubule[, -c(1:3)])))

ref_mouse_tubule_sce <- SingleCellExperiment(assays = list(tpm = mouse_tubule[, -c(1:3)]), 
                                             rowData = rowdata, 
                                             colData = coldata)

saveRDS(ref_mouse_tubule_sce, 
        file = "../../git/data/kidney/kidney-map/mouse-tubule/ref_mouse_tubule_sce.rds")
```


## prepare dev cell data
```{r}
library(DropletUtils)
library(scran)
library(scater)

dev_cell_sce <- read10xCounts("../data/kidney/kidney-map/dev-cell/Mouse_Adult_DGE/")
dev_cell_sce
colData(dev_cell_sce) %>% as.data.frame()
```

```{r}
final_frac <- readRDS("../Bio-packages/kidneycellexplorer/data/expr_data.rds")
```














