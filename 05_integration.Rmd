---
title: "integration"
author: "YinCY"
date: 2023-0330
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Integration with harmony
```{r}
library(dplyr)
library(scran)
library(scater)
library(batchelor)
library(harmony)

sym_sce <- readRDS("../data/kidney/kidney-map/GSE78845/sym_sce.rds")
drg_sce <- readRDS("../data/kidney/kidney-map/GSE175421/drg_sce.rds")
glomer_sce <- readRDS("../data/kidney/kidney-map/GSE146912/glomer_sce.rds")
dev_cell_sce <- readRDS("../data/kidney/kidney-map/GSE129798/dev_cell_sce.rds")


sample_meta <- data.frame(
    cell_ids = c(colnames(drg_sce), colnames(sym_sce), 
                 colnames(glomer_sce), colnames(dev_cell_sce)),
    
    geo_accession = rep(c("GSE175421", "GSE78845", "GSE146912", "GSE129798"), 
                        times = c(dim(drg_sce)[2], dim(sym_sce)[2], 
                                  dim(glomer_sce)[2], dim(dev_cell_sce)[2])), 
    
    cell_type = c(drg_sce$cell_type, sym_sce$cell_type, 
                  glomer_sce$cell_type, dev_cell_sce$cell_type), 
    
    mito_percent = c(drg_sce$mito_percent, sym_sce$mito_percent, 
                                glomer_sce$mito_percent, dev_cell_sce$mito_percent), 
    
    location = factor(c(drg_sce$location, sym_sce$location, glomer_sce$location, dev_cell_sce$location), 
                      levels = c("Cortex", "outer medulla", "inner medulla", "Spine")))
rownames(sample_meta) <- sample_meta$cell_ids
sample_meta

source("R/harmoniseSCE.R")
counts <- harmonizeSCE(sce_list = list(drg_sce, sym_sce, glomer_sce, dev_cell_sce), method = "harmony")

library(AnnotationHub)
ah <- AnnotationHub()
query(ah, c("Mus musculus", "EnsDb"))
ensdb <- ah[["AH104895"]]
gene_df <- data.frame(ensembl = rownames(counts), 
                      symbol = mapIds(ensdb, keys = rownames(counts), keytype = "GENEID", column = "SYMBOL"))
gene_df %>% head

sces <- SingleCellExperiment(assays = list(counts = counts), 
                             rowData = gene_df, 
                             colData = sample_meta)
sces
```



```{r}
set.seed(101)
sces <- multiBatchNorm(sces, batch = sces$geo_accession, normalize.all = TRUE)

vars <- modelGeneVar(sces, block = sces$geo_accession)
hvgs <- getTopHVGs(vars, n = 5000)
hvgs %>% str

set.seed(102)
npcs <- calculatePCA(sces, subset_row = hvgs)
library(PCAtools)
elbow <- findElbowPoint(attr(npcs, "percentVar"))
reducedDim(sces, "PCA") <- npcs[, 1:40]

set.seed(103)
sces <- RunHarmony(object = sces, 
                   group.by.vars = "geo_accession", 
                   reduction.save = "harmony", 
                   epsilon.harmony = 1e-06)

set.seed(104)
sces <- runTSNE(sces, dimred = "harmony")

# set.seed(105)
# sces <- runUMAP(sces, dimred = "harmony")


library(viridis)
plotTSNE(sces, 
         colour_by = "geo_accession", 
         point_size = 0.05, 
         text_by = "cell_type", 
         text_size = 1.5) +
    scale_color_viridis(discrete = TRUE) +
    theme(legend.position = "none")
    guides(size = guide_legend(override.aes = list(size = 3)))


ggsave("figures/harmony_TSNE_cell_type.pdf")
ggsave("figures/harmony_TSNE_location.pdf")
ggsave("figures/harmony_TSNE_datasets.pdf")

saveRDS(sces, "../data/kidney/kidney-map/integrated_data/harmonized_integrated.rds")
```



# Integration with RISC
```{r}
library(SingleCellExperiment)
library(RISC)
library(magrittr)

sym_sce <- readRDS("../data/kidney/kidney-map/GSE78845/sym_sce.rds")
drg_sce <- readRDS("../data/kidney/kidney-map/GSE175421/drg_sce.rds")
glomer_sce <- readRDS("../data/kidney/kidney-map/GSE146912/glomer_sce.rds")
dev_cell_sce <- readRDS("../data/kidney/kidney-map/GSE129798/dev_cell_sce.rds")


sces <- list(dev_cell = dev_cell_sce, drg = drg_sce, glomer = glomer_sce, sym = sym_sce)
source("R/harmoniseSCE.R")
sces <- harmonizeSCE(sces, method = "RISC")

# library(batchelor)
# set.seed(101)
# sces <- multiBatchNorm(sces[[1]], sces[[2]], sces[[3]], sces[[4]])

source("R/createRISC.R")
sces <- createRISC(sce_list = sces)

rm(dev_cell_sce, drg_sce, sym_sce, glomer_sce)
gc()
```


```{r}
pro <- function(x, ...){
        # do not filtering, is been done
        x <- scFilter(x,min.UMI = 0, max.UMI = Inf, min.gene = 0, 
                      min.cell = 0, mitochon = 1, is.filter = FALSE)
        
        # normalize the raw counts
        x <- scNormalize(x, ncore = 3)
        
        # find high variable genes
        x <- scDisperse(x)
    return(x)
}


set.seed(101)
sces <- lapply(sces, pro)
gc()

var_genes <- Reduce(union, lapply(sces, function(x){x@vargene})) %>% unique()
var_genes %>% str

scMultiIntegrate(objects = sces, 
                 eigens = 30, 
                 var.gene = var_genes, 
                 align = "OLS", 
                 npc = 50, 
                 ncore = 3, 
                 seed = 102)
sces <- .Last.value
gc()

set.seed(103)
sces <- scTSNE(sces, npc = 50, use = "PLS", perplexity = 30)

saveRDS(sces, "../data/kidney/kidney-map/integrated_data/RISC_integrated.rds")


library(ggplot2)
DimPlot(sces, 
        slot = "cell.tsne", 
        colFactor = "mito_percent", 
        label = TRUE, 
        label.font = 2, 
        adjust.label = 0) +
    theme(legend.position = "none")



ggsave("figures/RISC_TSNE_cell_type.pdf")
```



# Integration with fastMNN
```{r}
library(SingleCellExperiment)
library(scran)
library(batchelor)


sym_sce <- readRDS("../data/kidney/kidney-map/GSE78845/sym_sce.rds")
drg_sce <- readRDS("../data/kidney/kidney-map/GSE175421/drg_sce.rds")
glomer_sce <- readRDS("../data/kidney/kidney-map/GSE146912/glomer_sce.rds")
dev_cell_sce <- readRDS("../data/kidney/kidney-map/GSE129798/dev_cell_sce.rds")

sces <- list(dev_cell = dev_cell_sce, 
             glomer = glomer_sce, 
             sym = sym_sce,
             drg = drg_sce)

source("R/harmoniseSCE.R")
sces <- harmonizeSCE(sces, method = "fastMNN")

set.seed(101)
sces <- multiBatchNorm(sces[[1]], sces[[2]], sces[[3]], sces[[4]])

set.seed(102)
dec_list <- lapply(sces, modelGeneVar)
combined_dec <- combineVar(dec_list[[1]], dec_list[[2]], dec_list[[3]], dec_list[[4]])
hvgs <- getTopHVGs(combined_dec, n = 3000)
hvgs %>% str

rm(dev_cell_sce, glomer_sce, drg_sce, sym_sce)
gc()
```


```{r}
library(scater)
library(dplyr)

set.seed(103)
combined_sces <- correctExperiments(sces[[1]], sces[[2]], sces[[3]], sces[[4]], 
                                    include.rowdata = TRUE, 
                                    PARAM = FastMnnParam())

set.seed(104)
combined_sces <- runPCA(combined_sces, subset_row = hvgs)
combined_sces <- runTSNE(combined_sces, dimred = "PCA", perplexity = 30)
saveRDS(combined_sces, "../data/kidney/kidney-map/integrated_data/fastMNN_integrated.rds")
```


```{r}
library(ggplot2)
library(scater)
library(ggrepel)

cell_location <- colData(combined_sces) %>% as.data.frame() %>% cbind(reducedDim(combined_sces, 3)) %>% 
    group_by(cell_type) %>% 
    summarise(x = median(TSNE1), 
              y = median(TSNE2))

combined_sces$location <- factor(combined_sces$location, levels = c("Cortex", "outer medulla", "inner medulla", "Spine"))

ggcells(combined_sces, aes(TSNE.1, TSNE.2)) +
    geom_point(aes(colour = cell_type), size = 0.5, alpha = 1/3, show.legend = T) +
    geom_text_repel(data = cell_location, aes(x, y, label = cell_type), size = 2.5) +
    viridis::scale_color_viridis(discrete = T) +
    theme_classic() +
    theme(legend.position = "none")
    guides(colour = guide_legend(override.aes = list(alpha = 1, size = 3)))

ggsave("figures/fastMNN_cell_type.pdf")
```



# Integration with Seurat
```{r}
library(Seurat)
library(magrittr)
library(ggplot2)

sym_sce <- readRDS("../data/kidney/kidney-map/GSE78845/sym_sce.rds")
drg_sce <- readRDS("../data/kidney/kidney-map/GSE175421/drg_sce.rds")
glomer_sce <- readRDS("../data/kidney/kidney-map/GSE146912/glomer_sce.rds")
dev_cell_sce <- readRDS("../data/kidney/kidney-map/GSE129798/dev_cell_sce.rds")


kidney_list <- list(dev_cell = dev_cell_sce, 
                    glomer = glomer_sce, 
                    drg = drg_sce, 
                    sym = sym_sce)

# remove unused files to save space
rm(sym_sce, drg_sce, glomer_sce, dev_cell_sce)
gc()

kidney_list <- lapply(kidney_list, FUN = as.Seurat)

kidney_list <- lapply(kidney_list, 
                      FUN = SCTransform, 
                      seed.use = 101, 
                      variable.features.n = 5000, 
                      assay = "originalexp",
                      vars.to.regress = "mito_percent")

features <- SelectIntegrationFeatures(kidney_list, nfeatures = 5000)
features %>% str

kidney_list <- PrepSCTIntegration(kidney_list, anchor.features = features)
anchors <- FindIntegrationAnchors(kidney_list, normalization.method = "SCT", anchor.features = features)
rm(kidney_list);gc()

kidney_integrated <- IntegrateData(anchorset = anchors, normalization.method = "SCT")
```


```{r}
rm(anchors);gc()

set.seed(102)
kidney_integrated <- RunPCA(kidney_integrated, verbose = TRUE) %>% 
    RunTSNE(reduction = "pca", dims = 1:50)

saveRDS(kidney_integrated, "../data/kidney/kidney-map/integrated_data/Seurat_integrated.rds")
```







